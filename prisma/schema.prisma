// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// 部署マスタ
model Department {
  id        Int      @id @default(autoincrement())
  name      String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  users User[]

  @@map("departments")
}

// ユーザー（営業マスタ）
model User {
  id           Int      @id @default(autoincrement())
  name         String
  email        String   @unique
  passwordHash String   @map("password_hash")
  departmentId Int?     @map("department_id")
  role         Role     @default(SALES)
  managerId    Int?     @map("manager_id")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  department   Department?   @relation(fields: [departmentId], references: [id])
  manager      User?         @relation("ManagerSubordinates", fields: [managerId], references: [id])
  subordinates User[]        @relation("ManagerSubordinates")
  dailyReports DailyReport[]
  comments     Comment[]

  @@map("users")
}

enum Role {
  SALES
  MANAGER
  ADMIN
}

// 顧客マスタ
model Customer {
  id            Int      @id @default(autoincrement())
  name          String
  address       String?
  phone         String?
  contactPerson String?  @map("contact_person")
  email         String?
  notes         String?
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  visitRecords VisitRecord[]

  @@map("customers")
}

// 日報
model DailyReport {
  id          Int          @id @default(autoincrement())
  userId      Int          @map("user_id")
  reportDate  DateTime     @map("report_date")
  status      ReportStatus @default(DRAFT)
  submittedAt DateTime?    @map("submitted_at")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  user         User          @relation(fields: [userId], references: [id])
  visitRecords VisitRecord[]
  comments     Comment[]

  @@unique([userId, reportDate])
  @@map("daily_reports")
}

enum ReportStatus {
  DRAFT
  SUBMITTED
}

// 訪問記録
model VisitRecord {
  id            Int      @id @default(autoincrement())
  dailyReportId Int      @map("daily_report_id")
  customerId    Int      @map("customer_id")
  visitDatetime DateTime @map("visit_datetime")
  purpose       String
  content       String
  problem       String?
  plan          String?
  displayOrder  Int      @default(0) @map("display_order")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  dailyReport DailyReport @relation(fields: [dailyReportId], references: [id], onDelete: Cascade)
  customer    Customer    @relation(fields: [customerId], references: [id])

  @@map("visit_records")
}

// コメント
model Comment {
  id            Int      @id @default(autoincrement())
  dailyReportId Int      @map("daily_report_id")
  userId        Int      @map("user_id")
  content       String
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  dailyReport DailyReport @relation(fields: [dailyReportId], references: [id], onDelete: Cascade)
  user        User        @relation(fields: [userId], references: [id])

  @@map("comments")
}
